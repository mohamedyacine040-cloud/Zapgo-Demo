<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapgo - UK EV Charging Site Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/998c8b0ab8.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" >
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .site-marker {
            transition: all 0.2s ease;
        }
        .site-marker:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Auto-Update Notification -->
    <div id="auto-update-banner" class="hidden bg-green-500 text-white px-4 py-2 text-center text-sm">
        <i class="fas fa-sync-alt mr-2"></i>
        <span id="auto-update-text">New sites discovered! Dashboard updated.</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-900 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-charging-station text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold">Zapgo</h1>
                </div>
                <div class="flex space-x-4">
                    <button onclick="showView('dashboard')" class="nav-btn px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button onclick="showView('scanner')" class="nav-btn px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i class="fas fa-search-location mr-2"></i>Scanner
                    </button>
                    <button onclick="showView('map')" class="nav-btn px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i class="fas fa-map-marked-alt mr-2"></i>Map
                    </button>
                    <button onclick="showView('sites')" class="nav-btn px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i class="fas fa-list mr-2"></i>Sites
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <h2 class="text-3xl font-bold mb-6">Dashboard</h2>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg shadow-lg text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Total Sites</p>
                            <p class="text-3xl font-bold mt-1" id="stat-total">0</p>
                        </div>
                        <i class="fas fa-map-marker-alt text-4xl text-blue-200"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg shadow-lg text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">High Potential</p>
                            <p class="text-3xl font-bold mt-1" id="stat-high">0</p>
                        </div>
                        <i class="fas fa-star text-4xl text-green-200"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-lg shadow-lg text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm">In Progress</p>
                            <p class="text-3xl font-bold mt-1" id="stat-progress">0</p>
                        </div>
                        <i class="fas fa-clock text-4xl text-yellow-200"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg shadow-lg text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Approved</p>
                            <p class="text-3xl font-bold mt-1" id="stat-approved">0</p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Scanner -->
            <div class="bg-gray-50 dark:bg-gray-900 p-6 rounded-lg shadow-lg mb-8">
                <h3 class="text-xl font-bold mb-4">Quick Area Scan</h3>
                <div class="flex gap-4">
                    <input
                        type="text"
                        id="quick-search"
                        placeholder="Enter UK city or postcode (e.g., Manchester, WD17 2UB)"
                        class="flex-1 px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                    <button onclick="quickScan()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition font-semibold">
                        <i class="fas fa-search mr-2"></i>Scan Area
                    </button>
                </div>
            </div>

            <!-- Recent Discoveries -->
            <div class="bg-gray-50 dark:bg-gray-900 p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4">Recent Discoveries</h3>
                <div id="recent-sites" class="space-y-3">
                    <p class="text-gray-500 dark:text-gray-400 text-center py-8">No sites discovered yet. Start scanning areas to find potential EV charging locations!</p>
                </div>
            </div>
        </div>

        <!-- Scanner View -->
        <div id="scanner-view" class="view hidden">
            <h2 class="text-3xl font-bold mb-6">AI-Powered Area Scanner</h2>

            <div class="bg-gray-50 dark:bg-gray-900 p-8 rounded-lg shadow-lg mb-6">
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Enter UK City or Postcode</label>
                    <input
                        type="text"
                        id="scanner-input"
                        placeholder="e.g., London, Manchester, Edinburgh, WD17 2UB, EH1 1YZ"
                        class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Automatically scans for ALL potential EV charging sites including supermarkets, car parks, sports centres, Power League, retail parks, hotels, restaurants, golf courses, business parks, and more
                    </p>
                </div>

                <button onclick="startScan()" class="w-full py-4 bg-primary text-white rounded-lg hover:bg-opacity-90 transition font-semibold text-lg">
                    <i class="fas fa-search mr-2"></i>Scan Area for Potential Sites
                </button>
            </div>

            <!-- Scanning Progress -->
            <div id="scan-progress" class="hidden bg-gray-50 dark:bg-gray-900 p-8 rounded-lg shadow-lg">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Scanning Area...</h3>
                    <p class="text-gray-600 dark:text-gray-400" id="scan-status">Analyzing potential sites...</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-4">
                        <div id="scan-progress-bar" class="bg-primary h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Scan Results -->
            <div id="scan-results" class="hidden">
                <h3 class="text-xl font-bold mb-4">Scan Results</h3>
                <div id="scan-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- Map View -->
        <div id="map-view" class="view hidden">
            <!-- Prominent Close Button - Always Visible -->
            <button id="close-map-btn" onclick="closeMapView()" class="hidden fixed top-20 right-8 z-[1000] bg-red-500 hover:bg-red-600 text-white w-14 h-14 rounded-full shadow-2xl items-center justify-center transition-all hover:scale-110 border-4 border-white dark:border-gray-800" title="Close Map & Return to Dashboard">
                <i class="fas fa-times text-2xl font-bold"></i>
            </button>

            <h2 class="text-3xl font-bold mb-6">Interactive Site Map</h2>

            <!-- Map Filters -->
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Site Type</label>
                        <select id="map-filter-type" onchange="filterMapMarkers()" class="w-full px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Min Profitability</label>
                        <select id="map-filter-profit" onchange="filterMapMarkers()" class="w-full px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <option value="0">All Sites</option>
                            <option value="7">7+ (High)</option>
                            <option value="5">5+ (Medium)</option>
                            <option value="3">3+ (Low)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Grid Connection</label>
                        <select id="map-filter-grid" onchange="filterMapMarkers()" class="w-full px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <option value="">All</option>
                            <option value="available">Available</option>
                            <option value="limited">Limited</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Status</label>
                        <select id="map-filter-status" onchange="filterMapMarkers()" class="w-full px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <option value="">All Statuses</option>
                            <option value="Potential">Potential</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Negotiating">Negotiating</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="relative bg-gray-200 dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden" style="height: 600px;">
                <div id="google-map" style="height: 100%; width: 100%;">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-6xl mb-4"></i>
                            <p class="text-xl">Map will load here</p>
                            <p class="text-sm mt-2">Start scanning to see sites on the map</p>
                        </div>
                    </div>
                </div>

                <!-- Scan This Area Button -->
                <button id="scan-map-area-btn" onclick="scanMapArea()" class="hidden absolute top-4 right-4 px-4 py-2 bg-primary text-white rounded-lg shadow-lg hover:bg-opacity-90 transition font-semibold text-sm z-10">
                    <i class="fas fa-search mr-2"></i>Scan This Area
                </button>

                <!-- Map Legend -->
                <div id="map-legend" class="hidden absolute bottom-4 left-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg z-10">
                    <h4 class="font-bold text-sm mb-2">Profitability Score</h4>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: #10b981;"></div>
                            <span>8-10 (Excellent)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: #eab308;"></div>
                            <span>6-7 (Good)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: #f97316;"></div>
                            <span>4-5 (Fair)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: #ef4444;"></div>
                            <span>1-3 (Low)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sites Browser View -->
        <div id="sites-view" class="view hidden">
            <h2 class="text-3xl font-bold mb-6">Site Browser</h2>

            <!-- Search and Filters -->
            <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                    <input
                        type="text"
                        id="sites-search"
                        placeholder="Search sites..."
                        onkeyup="filterSites()"
                        class="px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800"
                    >
                    <select id="filter-type" onchange="filterSites()" class="px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <option value="">All Types</option>
                    </select>
                    <select id="filter-status" onchange="filterSites()" class="px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <option value="">All Statuses</option>
                        <option value="Potential">Potential</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Negotiating">Negotiating</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <select id="filter-profit" onchange="filterSites()" class="px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <option value="0">All Profitability</option>
                        <option value="8">8+ (Excellent)</option>
                        <option value="7">7+ (High)</option>
                        <option value="5">5+ (Medium)</option>
                    </select>
                    <select id="sort-by" onchange="sortSites()" class="px-3 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <option value="profitability-desc">Profitability (High-Low)</option>
                        <option value="profitability-asc">Profitability (Low-High)</option>
                        <option value="revenue-desc">Revenue (High-Low)</option>
                        <option value="traffic-desc">Traffic (High-Low)</option>
                        <option value="name-asc">Name (A-Z)</option>
                    </select>
                </div>
            </div>

            <!-- Sites Table -->
            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 dark:bg-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Location</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Profitability</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Traffic</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sites-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                    No sites found. Start scanning areas to discover potential locations!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Detail Modal -->
    <div id="site-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold" id="modal-name"></h3>
                        <p class="text-gray-600 dark:text-gray-400" id="modal-type"></p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Location Info -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-map-marker-alt text-primary mr-2"></i>Location
                        </h4>
                        <p id="modal-address" class="text-sm mb-2"></p>
                        <p id="modal-postcode" class="text-sm"></p>
                    </div>

                    <!-- Traffic Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-car text-primary mr-2"></i>Traffic Analysis
                        </h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">Daily Visitors:</span> <span id="modal-traffic"></span></p>
                            <p><span class="font-semibold">Peak Hours:</span> <span id="modal-peak"></span></p>
                            <p><span class="font-semibold">Dwell Time:</span> <span id="modal-dwell"></span></p>
                            <p><span class="font-semibold">Road Traffic:</span> <span id="modal-road-traffic"></span></p>
                            <p><span class="font-semibold">Major Road:</span> <span id="modal-major-road"></span></p>
                        </div>
                    </div>

                    <!-- Grid Connection -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-plug text-primary mr-2"></i>Grid Connection
                        </h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">Status:</span> <span id="modal-grid-status"></span></p>
                            <p><span class="font-semibold">Capacity:</span> <span id="modal-grid-capacity"></span></p>
                            <p><span class="font-semibold">Connection Cost:</span> <span id="modal-grid-cost"></span></p>
                            <p><span class="font-semibold">Utility:</span> <span id="modal-grid-utility"></span></p>
                        </div>
                    </div>

                    <!-- Competitor Analysis -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-search-location text-primary mr-2"></i>Competitor Analysis
                        </h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">Nearest Charger:</span> <span id="modal-competitor"></span></p>
                            <p><span class="font-semibold">Chargers in 5km:</span> <span id="modal-competitors-count"></span></p>
                            <p><span class="font-semibold">Market Position:</span> <span id="modal-market"></span></p>
                        </div>
                    </div>

                    <!-- Financial Metrics -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-pound-sign text-primary mr-2"></i>Financial Metrics
                        </h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">Est. Monthly Revenue:</span> <span id="modal-revenue"></span></p>
                            <p><span class="font-semibold">Profitability Score:</span> <span id="modal-profit"></span></p>
                            <p><span class="font-semibold">Parking Spaces:</span> <span id="modal-parking"></span></p>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3 flex items-center">
                            <i class="fas fa-address-book text-primary mr-2"></i>Contact
                        </h4>
                        <div class="space-y-2 text-sm" id="modal-contact">
                        </div>
                    </div>
                </div>

                <!-- Status Update -->
                <div class="mt-6 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <h4 class="font-bold mb-3">Update Status</h4>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="updateSiteStatus('Potential')" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                            Potential
                        </button>
                        <button onclick="updateSiteStatus('Contacted')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">
                            Contacted
                        </button>
                        <button onclick="updateSiteStatus('Negotiating')" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-sm">
                            Negotiating
                        </button>
                        <button onclick="updateSiteStatus('Approved')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                            Approved
                        </button>
                        <button onclick="updateSiteStatus('Rejected')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                            Rejected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data Storage (in-memory for iframe compatibility)
        let sites = [];
        let currentSiteId = null;
        let map = null;
        let markerLayer = null;
        let dailyUpdateInterval = null;
        let lastUpdateDate = new Date().toDateString();

        // Complete UK Coverage - All Major Cities and Towns
        const ukLocations = {
            // England - London & South East
            'london': { lat: 51.5074, lng: -0.1278 }, 'croydon': { lat: 51.3762, lng: -0.0982 },
            'bromley': { lat: 51.4064, lng: 0.0224 }, 'barking': { lat: 51.5362, lng: 0.0798 },
            'ilford': { lat: 51.5588, lng: 0.0883 }, 'romford': { lat: 51.5779, lng: 0.1821 },
            'enfield': { lat: 51.6523, lng: -0.0808 }, 'harrow': { lat: 51.5898, lng: -0.3346 },
            'brent': { lat: 51.5588, lng: -0.2817 }, 'ealing': { lat: 51.5130, lng: -0.3089 },
            'hounslow': { lat: 51.4671, lng: -0.3611 }, 'richmond': { lat: 51.4613, lng: -0.3037 },
            'kingston': { lat: 51.4123, lng: -0.3006 }, 'sutton': { lat: 51.3618, lng: -0.1945 },
            'merton': { lat: 51.4098, lng: -0.2108 }, 'wandsworth': { lat: 51.4571, lng: -0.1819 },
            'brighton': { lat: 50.8225, lng: -0.1372 }, 'eastbourne': { lat: 50.7680, lng: 0.2905 },
            'hastings': { lat: 50.8543, lng: 0.5732 }, 'crawley': { lat: 51.1107, lng: -0.1863 },
            'worthing': { lat: 50.8148, lng: -0.3716 }, 'dover': { lat: 51.1279, lng: 1.3134 },
            'folkestone': { lat: 51.0814, lng: 1.1696 }, 'maidstone': { lat: 51.2704, lng: 0.5227 },
            'canterbury': { lat: 51.2802, lng: 1.0789 }, 'gillingham': { lat: 51.3886, lng: 0.5481 },
            'chatham': { lat: 51.3795, lng: 0.5287 }, 'rochester': { lat: 51.3880, lng: 0.5054 },
            'basingstoke': { lat: 51.2664, lng: -1.0871 }, 'slough': { lat: 51.5105, lng: -0.5950 },
            'reading': { lat: 51.4543, lng: -0.9781 }, 'bracknell': { lat: 51.4156, lng: -0.7493 },
            'maidenhead': { lat: 51.5217, lng: -0.7177 }, 'woking': { lat: 51.3168, lng: -0.5600 },
            'guildford': { lat: 51.2362, lng: -0.5704 }, 'watford': { lat: 51.6565, lng: -0.3960 },
            'hemel hempstead': { lat: 51.7533, lng: -0.4689 }, 'stevenage': { lat: 51.9015, lng: -0.2020 },
            'st albans': { lat: 51.7548, lng: -0.3363 }, 'luton': { lat: 51.8787, lng: -0.4200 },
            'dunstable': { lat: 51.8860, lng: -0.5206 }, 'bedford': { lat: 52.1357, lng: -0.4668 },
            'oxford': { lat: 51.7520, lng: -1.2577 }, 'high wycombe': { lat: 51.6287, lng: -0.7482 },
            'aylesbury': { lat: 51.8168, lng: -0.8124 }, 'milton keynes': { lat: 52.0406, lng: -0.7594 },
            'portsmouth': { lat: 50.8198, lng: -1.0880 }, 'southampton': { lat: 50.9097, lng: -1.4044 },
            'bournemouth': { lat: 50.7192, lng: -1.8808 }, 'poole': { lat: 50.7150, lng: -1.9873 },
            'salisbury': { lat: 51.0693, lng: -1.7944 }, 'winchester': { lat: 51.0632, lng: -1.3080 },

            // England - South West
            'bristol': { lat: 51.4545, lng: -2.5879 }, 'bath': { lat: 51.3751, lng: -2.3597 },
            'weston super mare': { lat: 51.3461, lng: -2.9772 }, 'gloucester': { lat: 51.8642, lng: -2.2381 },
            'cheltenham': { lat: 51.8994, lng: -2.0783 }, 'swindon': { lat: 51.5558, lng: -1.7797 },
            'exeter': { lat: 50.7184, lng: -3.5339 }, 'plymouth': { lat: 50.3755, lng: -4.1427 },
            'torquay': { lat: 50.4619, lng: -3.5253 }, 'paignton': { lat: 50.4355, lng: -3.5614 },
            'torbay': { lat: 50.4398, lng: -3.5564 }, 'barnstaple': { lat: 51.0805, lng: -4.0591 },
            'truro': { lat: 50.2632, lng: -5.0510 }, 'penzance': { lat: 50.1186, lng: -5.5371 },
            'newquay': { lat: 50.4120, lng: -5.0757 }, 'falmouth': { lat: 50.1538, lng: -5.0700 },
            'taunton': { lat: 51.0188, lng: -3.1006 }, 'yeovil': { lat: 50.9415, lng: -2.6318 },

            // England - Midlands
            'birmingham': { lat: 52.4862, lng: -1.8904 }, 'coventry': { lat: 52.4068, lng: -1.5197 },
            'wolverhampton': { lat: 52.5865, lng: -2.1289 }, 'walsall': { lat: 52.5862, lng: -1.9829 },
            'dudley': { lat: 52.5077, lng: -2.0885 }, 'west bromwich': { lat: 52.5188, lng: -1.9950 },
            'solihull': { lat: 52.4118, lng: -1.7776 }, 'sutton coldfield': { lat: 52.5643, lng: -1.8240 },
            'leicester': { lat: 52.6369, lng: -1.1398 }, 'nottingham': { lat: 52.9548, lng: -1.1581 },
            'derby': { lat: 52.9225, lng: -1.4746 }, 'northampton': { lat: 52.2405, lng: -0.9027 },
            'stoke': { lat: 53.0027, lng: -2.1794 }, 'telford': { lat: 52.6766, lng: -2.4469 },
            'shrewsbury': { lat: 52.7081, lng: -2.7535 }, 'hereford': { lat: 52.0565, lng: -2.7160 },
            'worcester': { lat: 52.1936, lng: -2.2219 }, 'warwick': { lat: 52.2819, lng: -1.5849 },
            'rugby': { lat: 52.3707, lng: -1.2634 }, 'nuneaton': { lat: 52.5232, lng: -1.4684 },
            'tamworth': { lat: 52.6335, lng: -1.6910 }, 'burton': { lat: 52.8038, lng: -1.6361 },

            // England - East
            'cambridge': { lat: 52.2053, lng: 0.1218 }, 'peterborough': { lat: 52.5695, lng: -0.2405 },
            'norwich': { lat: 52.6309, lng: 1.2974 }, 'ipswich': { lat: 52.0594, lng: 1.1556 },
            'colchester': { lat: 51.8890, lng: 0.9035 }, 'chelmsford': { lat: 51.7356, lng: 0.4685 },
            'southend': { lat: 51.5459, lng: 0.7077 }, 'basildon': { lat: 51.5760, lng: 0.4887 },
            'harlow': { lat: 51.7787, lng: 0.1074 }, 'bury st edmunds': { lat: 52.2465, lng: 0.7107 },
            'kings lynn': { lat: 52.7532, lng: 0.3963 }, 'great yarmouth': { lat: 52.6086, lng: 1.7303 },
            'lowestoft': { lat: 52.4773, lng: 1.7505 },

            // England - North West
            'manchester': { lat: 53.4808, lng: -2.2426 }, 'liverpool': { lat: 53.4084, lng: -2.9916 },
            'bolton': { lat: 53.5768, lng: -2.4282 }, 'stockport': { lat: 53.4106, lng: -2.1575 },
            'oldham': { lat: 53.5444, lng: -2.1169 }, 'rochdale': { lat: 53.6097, lng: -2.1561 },
            'salford': { lat: 53.4875, lng: -2.2901 }, 'wigan': { lat: 53.5448, lng: -2.6318 },
            'warrington': { lat: 53.3900, lng: -2.5970 }, 'st helens': { lat: 53.4500, lng: -2.7374 },
            'blackpool': { lat: 53.8175, lng: -3.0357 }, 'preston': { lat: 53.7632, lng: -2.7031 },
            'blackburn': { lat: 53.7480, lng: -2.4821 }, 'burnley': { lat: 53.7889, lng: -2.2489 },
            'lancaster': { lat: 54.0466, lng: -2.8007 }, 'carlisle': { lat: 54.8951, lng: -2.9382 },
            'chester': { lat: 53.1908, lng: -2.8908 }, 'crewe': { lat: 53.0979, lng: -2.4416 },

            // England - Yorkshire
            'leeds': { lat: 53.8008, lng: -1.5491 }, 'sheffield': { lat: 53.3811, lng: -1.4701 },
            'bradford': { lat: 53.7960, lng: -1.7594 }, 'york': { lat: 53.9591, lng: -1.0815 },
            'hull': { lat: 53.7457, lng: -0.3367 }, 'doncaster': { lat: 53.5228, lng: -1.1289 },
            'wakefield': { lat: 53.6830, lng: -1.4990 }, 'rotherham': { lat: 53.4326, lng: -1.3635 },
            'barnsley': { lat: 53.5526, lng: -1.4797 }, 'huddersfield': { lat: 53.6458, lng: -1.7850 },
            'halifax': { lat: 53.7256, lng: -1.8632 }, 'harrogate': { lat: 53.9921, lng: -1.5418 },
            'scarborough': { lat: 54.2797, lng: -0.4044 }, 'middlesbrough': { lat: 54.5742, lng: -1.2349 },

            // England - North East
            'newcastle': { lat: 54.9783, lng: -1.6178 }, 'sunderland': { lat: 54.9069, lng: -1.3838 },
            'gateshead': { lat: 54.9526, lng: -1.6033 }, 'south shields': { lat: 55.0003, lng: -1.4323 },
            'north shields': { lat: 55.0174, lng: -1.4493 }, 'durham': { lat: 54.7761, lng: -1.5733 },
            'darlington': { lat: 54.5268, lng: -1.5528 }, 'hartlepool': { lat: 54.6916, lng: -1.2119 },

            // Scotland
            'edinburgh': { lat: 55.9533, lng: -3.1883 }, 'glasgow': { lat: 55.8642, lng: -4.2518 },
            'aberdeen': { lat: 57.1497, lng: -2.0943 }, 'dundee': { lat: 56.4620, lng: -2.9707 },
            'inverness': { lat: 57.4778, lng: -4.2247 }, 'stirling': { lat: 56.1165, lng: -3.9369 },
            'perth': { lat: 56.3960, lng: -3.4373 }, 'paisley': { lat: 55.8456, lng: -4.4239 },
            'hamilton': { lat: 55.7781, lng: -4.0393 }, 'livingston': { lat: 55.9027, lng: -3.5223 },
            'kirkcaldy': { lat: 56.1121, lng: -3.1594 }, 'ayr': { lat: 55.4580, lng: -4.6293 },

            // Wales
            'cardiff': { lat: 51.4816, lng: -3.1791 }, 'swansea': { lat: 51.6214, lng: -3.9436 },
            'newport': { lat: 51.5842, lng: -2.9977 }, 'wrexham': { lat: 53.0462, lng: -2.9930 },
            'barry': { lat: 51.4007, lng: -3.2669 }, 'merthyr tydfil': { lat: 51.7487, lng: -3.3816 },
            'neath': { lat: 51.6605, lng: -3.8073 }, 'port talbot': { lat: 51.5911, lng: -3.7945 },
            'llanelli': { lat: 51.6823, lng: -4.1622 }, 'bangor': { lat: 53.2280, lng: -4.1291 },

            // Northern Ireland
            'belfast': { lat: 54.5973, lng: -5.9301 }, 'derry': { lat: 54.9966, lng: -7.3086 },
            'lisburn': { lat: 54.5162, lng: -6.0581 }, 'newry': { lat: 54.1751, lng: -6.3402 },
            'armagh': { lat: 54.3503, lng: -6.6528 }
        };

        // Sample UK postcodes
        const ukPostcodes = {
            'wd17 2ub': { lat: 51.6565, lng: -0.3960, city: 'Watford' },
            'eh1 1yz': { lat: 55.9533, lng: -3.1883, city: 'Edinburgh' },
            'm1 1ae': { lat: 53.4808, lng: -2.2426, city: 'Manchester' },
            'b1 1aa': { lat: 52.4862, lng: -1.8904, city: 'Birmingham' },
            'ls1 1aa': { lat: 53.8008, lng: -1.5491, city: 'Leeds' },
            'l1 1aa': { lat: 53.4084, lng: -2.9916, city: 'Liverpool' },
            'g1 1aa': { lat: 55.8642, lng: -4.2518, city: 'Glasgow' },
            'cf10 1aa': { lat: 51.4816, lng: -3.1791, city: 'Cardiff' },
            'bt1 1aa': { lat: 54.5973, lng: -5.9301, city: 'Belfast' },
            'sw1a 1aa': { lat: 51.5014, lng: -0.1419, city: 'London' }
        };

        // Site types and their properties
        const siteTypes = [
            'Supermarket', 'Car Park', 'Pub', 'Restaurant',
            'Shopping Centre', 'Hotel', 'Gym', 'Petrol Station',
            'Hospital', 'School', 'Business Park', 'Cinema',
            'Sports Centre', 'Power League', 'Retail Park', 'Golf Course',
            'Train Station', 'Airport', 'University', 'College',
            'Library', 'Community Centre', 'Leisure Centre', 'Swimming Pool',
            'Bowling Alley', 'Bingo Hall', 'Casino', 'Theatre',
            'Museum', 'Park & Ride', 'Church', 'Mosque',
            'Garden Centre', 'DIY Store', 'Furniture Store', 'Outlet Centre',
            'Football Stadium', 'Cricket Ground', 'Rugby Club', 'Tennis Centre',
            'Trampoline Park', 'Climbing Centre', 'Skate Park', 'Equestrian Centre',
            'Warehouse', 'Distribution Centre', 'Office Block', 'Tech Park',
            'Holiday Park', 'Caravan Park', 'Marina', 'Beach Car Park'
        ];

        // UK utility companies
        const utilities = [
            'Scottish and Southern Energy', 'UK Power Networks',
            'Northern Powergrid', 'Electricity North West',
            'Western Power Distribution', 'National Grid'
        ];

        // UK major roads
        const majorRoads = [
            'M1', 'M25', 'M6', 'M4', 'M5', 'M40', 'M3', 'M62',
            'A1', 'A2', 'A3', 'A4', 'A5', 'A40', 'A406'
        ];

        // Generate realistic site data
        function generateSite(location, type, cityName) {
            const names = {
                'Supermarket': ['Tesco Extra', 'Sainsbury\'s', 'Asda Superstore', 'Morrison\'s', 'Waitrose', 'Aldi', 'Lidl', 'M&S Food Hall'],
                'Car Park': ['NCP Car Park', 'Q-Park', 'City Centre Car Park', 'Multi-Storey Car Park', 'APCOA Car Park'],
                'Pub': ['The Crown', 'The Red Lion', 'The Kings Arms', 'The White Hart', 'Wetherspoons', 'Greene King'],
                'Restaurant': ['Pizza Express', 'Nando\'s', 'Wagamama', 'Zizzi', 'TGI Fridays', 'Frankie & Benny\'s'],
                'Shopping Centre': ['Westfield', 'Intu', 'The Mall', 'Retail Park', 'The Arcade'],
                'Hotel': ['Premier Inn', 'Travelodge', 'Holiday Inn', 'Hilton', 'Marriott', 'DoubleTree'],
                'Gym': ['PureGym', 'The Gym', 'David Lloyd', 'Virgin Active', 'Fitness First', 'Nuffield Health'],
                'Petrol Station': ['BP', 'Shell', 'Tesco Petrol', 'Sainsbury\'s Petrol', 'Esso', 'Texaco'],
                'Hospital': ['General Hospital', 'Royal Infirmary', 'Community Hospital', 'Medical Centre'],
                'School': ['Community College', 'Academy', 'Secondary School', 'Sixth Form College'],
                'Business Park': ['Business Park', 'Office Complex', 'Trade Centre', 'Enterprise Park'],
                'Cinema': ['Vue Cinema', 'Odeon', 'Cineworld', 'Showcase Cinema', 'Everyman'],
                'Sports Centre': ['Sports Centre', 'Sports Complex', 'Athletic Centre', 'Leisure Sport'],
                'Power League': ['Power League', 'Goals Soccer Centre', '5-a-side Centre', 'Powerleague'],
                'Retail Park': ['Retail Park', 'Shopping Park', 'Commercial Park', 'Outlet Park'],
                'Golf Course': ['Golf Club', 'Golf Course', 'Country Club Golf', 'Municipal Golf Course'],
                'Train Station': ['Railway Station', 'Train Station', 'Central Station'],
                'Airport': ['Regional Airport', 'International Airport', 'City Airport'],
                'University': ['University Campus', 'University', 'Higher Education Campus'],
                'College': ['College Campus', 'Further Education College', 'Technical College'],
                'Library': ['Central Library', 'Public Library', 'Community Library'],
                'Community Centre': ['Community Centre', 'Community Hub', 'Village Hall'],
                'Leisure Centre': ['Leisure Centre', 'Sports & Leisure Centre', 'Recreation Centre'],
                'Swimming Pool': ['Swimming Pool', 'Aquatics Centre', 'Leisure Pool'],
                'Bowling Alley': ['Ten Pin Bowling', 'Hollywood Bowl', 'AMF Bowl'],
                'Bingo Hall': ['Mecca Bingo', 'Gala Bingo', 'Buzz Bingo'],
                'Casino': ['Grosvenor Casino', 'Genting Casino', 'Les Croupiers Casino'],
                'Theatre': ['Theatre', 'Playhouse', 'Arts Centre', 'Concert Hall'],
                'Museum': ['Museum', 'Heritage Centre', 'Art Gallery'],
                'Park & Ride': ['Park & Ride', 'Park and Ride Facility', 'Commuter Car Park'],
                'Church': ['Parish Church', 'Community Church', 'Methodist Church'],
                'Mosque': ['Central Mosque', 'Islamic Centre', 'Community Mosque'],
                'Garden Centre': ['Garden Centre', 'Garden & Leisure', 'Wyevale Garden Centre'],
                'DIY Store': ['B&Q', 'Homebase', 'Wickes', 'Screwfix'],
                'Furniture Store': ['IKEA', 'DFS', 'ScS Sofas', 'Furniture Village'],
                'Outlet Centre': ['Outlet Shopping', 'Designer Outlet', 'Factory Outlet'],
                'Football Stadium': ['Football Stadium', 'FC Ground', 'Football Club'],
                'Cricket Ground': ['Cricket Club', 'County Cricket Ground', 'Cricket Ground'],
                'Rugby Club': ['Rugby Club', 'RFC Ground', 'Rugby Union Club'],
                'Tennis Centre': ['Tennis Centre', 'Tennis Club', 'LTA Tennis Centre'],
                'Trampoline Park': ['Jump Arena', 'Flip Out', 'Oxygen Trampoline Park'],
                'Climbing Centre': ['Climbing Centre', 'Bouldering Centre', 'Vertical Adventures'],
                'Skate Park': ['Skate Park', 'BMX & Skate Park', 'Action Sports Park'],
                'Equestrian Centre': ['Equestrian Centre', 'Riding School', 'Stables & Arena'],
                'Warehouse': ['Distribution Warehouse', 'Storage Facility', 'Logistics Centre'],
                'Distribution Centre': ['Distribution Centre', 'Fulfilment Centre', 'DC Warehouse'],
                'Office Block': ['Office Building', 'Business Centre', 'Corporate Offices'],
                'Tech Park': ['Technology Park', 'Innovation Centre', 'Science Park'],
                'Holiday Park': ['Holiday Park', 'Caravan & Lodge Park', 'Resort Park'],
                'Caravan Park': ['Caravan Park', 'Touring Park', 'Static Caravan Site'],
                'Marina': ['Marina', 'Yacht Club', 'Harbour Marina'],
                'Beach Car Park': ['Beach Car Park', 'Coastal Car Park', 'Seafront Parking']
            };

            const trafficCounts = Math.floor(Math.random() * 8000) + 2000;
            const dwellTime = type === 'Supermarket' ? '45-60 mins' :
                             type === 'Shopping Centre' ? '90-120 mins' :
                             type === 'Hotel' ? '8-12 hours' :
                             type === 'Gym' ? '60-90 mins' :
                             type === 'Restaurant' ? '45-75 mins' :
                             '30-45 mins';

            const gridCapacity = Math.floor(Math.random() * 300) + 100;
            const gridStatus = gridCapacity > 250 ? 'Available' : gridCapacity > 150 ? 'Limited' : 'Requires Upgrade';
            const connectionCost = Math.floor(Math.random() * 30000) + 10000;

            const competitorDistance = Math.random() * 8 + 0.5;
            const profitability = Math.min(10, Math.max(1,
                Math.floor((trafficCounts / 1000) + (gridCapacity / 30) + (competitorDistance * 0.5))
            ));

            const revenue = Math.floor((trafficCounts * 0.3 * 0.5 * 30) + (profitability * 500));

            // Determine if site has parking based on type
            const sitesWithParking = [
                'Supermarket', 'Car Park', 'Shopping Centre', 'Hotel', 'Gym', 'Petrol Station',
                'Hospital', 'School', 'Business Park', 'Cinema', 'Sports Centre', 'Power League',
                'Retail Park', 'Golf Course', 'Train Station', 'Airport', 'University', 'College',
                'Leisure Centre', 'Swimming Pool', 'Bowling Alley', 'Bingo Hall', 'Casino',
                'Theatre', 'Museum', 'Park & Ride', 'Garden Centre', 'DIY Store', 'Furniture Store',
                'Outlet Centre', 'Football Stadium', 'Cricket Ground', 'Rugby Club', 'Tennis Centre',
                'Trampoline Park', 'Climbing Centre', 'Equestrian Centre', 'Warehouse',
                'Distribution Centre', 'Office Block', 'Tech Park', 'Holiday Park', 'Caravan Park',
                'Marina', 'Beach Car Park', 'Restaurant'
            ];

            const hasParking = sitesWithParking.includes(type);
            const parkingSpaces = hasParking ? Math.floor(Math.random() * 300) + 30 : null;

            const roadTraffic = Math.floor(Math.random() * 50000) + 10000;
            const majorRoad = majorRoads[Math.floor(Math.random() * majorRoads.length)];
            const roadDistance = (Math.random() * 2 + 0.1).toFixed(1);

            // 40% of sites won't have contact details
            const hasContact = Math.random() > 0.4;

            return {
                id: Date.now() + Math.random(),
                name: names[type][Math.floor(Math.random() * names[type].length)],
                type: type,
                address: `${Math.floor(Math.random() * 500) + 1} ${['High Street', 'Main Road', 'Park Lane', 'Station Road'][Math.floor(Math.random() * 4)]}`,
                city: cityName,
                postcode: generatePostcode(),
                lat: location.lat + (Math.random() - 0.5) * 0.05,
                lng: location.lng + (Math.random() - 0.5) * 0.05,
                traffic: {
                    daily: trafficCounts,
                    peak: type === 'Supermarket' ? '10am-2pm, 5pm-7pm' : '12pm-6pm',
                    dwellTime: dwellTime,
                    roadTraffic: roadTraffic,
                    majorRoad: majorRoad,
                    roadDistance: roadDistance
                },
                grid: {
                    status: gridStatus,
                    capacity: gridCapacity,
                    cost: connectionCost,
                    utility: utilities[Math.floor(Math.random() * utilities.length)]
                },
                competitors: {
                    nearest: competitorDistance.toFixed(1) + ' km',
                    count: Math.floor(Math.random() * 5),
                    market: competitorDistance > 3 ? 'Excellent' : competitorDistance > 1.5 ? 'Good' : 'Competitive'
                },
                profitability: profitability,
                revenue: revenue,
                parkingSpaces: parkingSpaces,
                contact: hasContact ? {
                    phone: `0${Math.floor(Math.random() * 9000000000) + 1000000000}`,
                    email: `manager@${names[type][0].toLowerCase().replace(/[^a-z]/g, '')}.co.uk`,
                    manager: ['John Smith', 'Sarah Johnson', 'David Williams', 'Emma Brown'][Math.floor(Math.random() * 4)]
                } : null,
                status: 'Potential',
                dateAdded: new Date().toISOString()
            };
        }

        function generatePostcode() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const area = letters[Math.floor(Math.random() * 26)] + letters[Math.floor(Math.random() * 26)];
            const district = Math.floor(Math.random() * 99) + 1;
            const sector = Math.floor(Math.random() * 9);
            const unit = letters[Math.floor(Math.random() * 26)] + letters[Math.floor(Math.random() * 26)];
            return `${area}${district} ${sector}${unit}`;
        }

        // Lookup location
        function lookupLocation(input) {
            const normalized = input.toLowerCase().trim().replace(/\s+/g, ' ');

            // Check if it's a postcode
            const postcodeNorm = normalized.replace(/\s/g, '');
            if (ukPostcodes[postcodeNorm]) {
                return { ...ukPostcodes[postcodeNorm], input: input };
            }

            // Check if it's a city
            if (ukLocations[normalized]) {
                return { ...ukLocations[normalized], city: input, input: input };
            }

            // Partial match for cities
            for (let city in ukLocations) {
                if (city.includes(normalized) || normalized.includes(city)) {
                    return { ...ukLocations[city], city: city, input: input };
                }
            }

            return null;
        }

        // Quick scan from dashboard
        function quickScan() {
            const input = document.getElementById('quick-search').value;
            if (!input) {
                showCustomAlert('Please enter a city or postcode');
                return;
            }

            showView('scanner');
            document.getElementById('scanner-input').value = input;
            setTimeout(() => startScan(), 300);
        }

        // Start scanning
        async function startScan(customLocation) {
            const input = customLocation || document.getElementById('scanner-input').value;
            if (!input) {
                showCustomAlert('Please enter a UK city or postcode');
                return;
            }

            const location = lookupLocation(input);
            if (!location) {
                showCustomAlert('Location not found. Please try: London, Manchester, Edinburgh, WD17 2UB, etc.');
                return;
            }

            // Automatically scan ALL site types
            const selectedTypes = siteTypes;

            // Show progress
            document.getElementById('scan-progress').classList.remove('hidden');
            document.getElementById('scan-results').classList.add('hidden');

            const cityName = location.city || location.input;
            const newSites = [];

            // 100% Coverage for ALL UK Cities and Towns
            // Major cities get wider coverage, towns get focused coverage
            const cityLower = cityName.toLowerCase();
            const majorCities = ['london', 'manchester', 'birmingham', 'leeds', 'liverpool', 'glasgow', 'edinburgh', 'bristol', 'sheffield', 'newcastle'];
            const isMajorCity = majorCities.some(city => cityLower.includes(city));

            // Full coverage radius for all locations
            const scanRadius = isMajorCity ? 0.4 : 0.15; // Major cities: ~40km, towns: ~15km (100% coverage everywhere)
            const sitesPerType = isMajorCity ? 5 : 3; // Major cities: 5-7 sites per type, towns: 3-5

            // ALL locations get ALL site types for complete 100% coverage
            const typesToScan = selectedTypes; // Scan EVERYTHING

            // Simulate scanning process
            for (let i = 0; i < typesToScan.length; i++) {
                const type = typesToScan[i];
                const progress = ((i + 1) / typesToScan.length) * 100;
                document.getElementById('scan-progress-bar').style.width = progress + '%';
                document.getElementById('scan-status').textContent = `Scanning for ${type}s...`;

                await new Promise(resolve => setTimeout(resolve, 300));

                // Generate sites for this type
                const count = Math.floor(Math.random() * 2) + sitesPerType; // 2-4 sites per type
                for (let j = 0; j < count; j++) {
                    // Use custom location with wider radius
                    const siteLocation = {
                        lat: location.lat + (Math.random() - 0.5) * scanRadius,
                        lng: location.lng + (Math.random() - 0.5) * scanRadius
                    };
                    const site = generateSite(siteLocation, type, cityName);
                    newSites.push(site);
                    sites.push(site);
                }
            }

            // Show results
            document.getElementById('scan-progress').classList.add('hidden');
            displayScanResults(newSites);
            updateDashboard();
            updateSitesTable();
            populateFilterDropdowns();
        }

        // Display scan results
        function displayScanResults(newSites) {
            const resultsDiv = document.getElementById('scan-results');
            const gridDiv = document.getElementById('scan-results-grid');

            gridDiv.innerHTML = newSites.map(site => `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg hover:shadow-xl transition cursor-pointer" onclick="openSiteModal('${site.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">${site.name}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${site.type}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${getProfitabilityColor(site.profitability)}">
                            ${site.profitability}/10
                        </span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p><i class="fas fa-map-marker-alt text-primary w-5"></i>${site.city}</p>
                        <p><i class="fas fa-users text-primary w-5"></i>${site.traffic.daily.toLocaleString()} daily visitors</p>
                        <p><i class="fas fa-pound-sign text-primary w-5"></i>£${site.revenue.toLocaleString()}/month</p>
                        <p><i class="fas fa-plug text-primary w-5"></i>${site.grid.status}</p>
                    </div>
                </div>
            `).join('');

            resultsDiv.classList.remove('hidden');
        }

        // Get profitability color
        function getProfitabilityColor(score) {
            if (score >= 8) return 'bg-green-500 text-white';
            if (score >= 6) return 'bg-yellow-500 text-white';
            if (score >= 4) return 'bg-orange-500 text-white';
            return 'bg-red-500 text-white';
        }

        // Update dashboard
        function updateDashboard() {
            document.getElementById('stat-total').textContent = sites.length;
            document.getElementById('stat-high').textContent = sites.filter(s => s.profitability >= 7).length;
            document.getElementById('stat-progress').textContent = sites.filter(s => s.status === 'Contacted' || s.status === 'Negotiating').length;
            document.getElementById('stat-approved').textContent = sites.filter(s => s.status === 'Approved').length;

            // Recent sites
            const recentDiv = document.getElementById('recent-sites');
            const recent = sites.slice(-5).reverse();

            if (recent.length === 0) {
                recentDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No sites discovered yet. Start scanning areas to find potential EV charging locations!</p>';
            } else {
                recentDiv.innerHTML = recent.map(site => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow hover:shadow-lg transition cursor-pointer" onclick="openSiteModal('${site.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${site.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${site.type} • ${site.city}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-semibold ${getProfitabilityColor(site.profitability)}">
                                ${site.profitability}/10
                            </span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Update sites table
        function updateSitesTable() {
            const tbody = document.getElementById('sites-table-body');

            if (sites.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                            No sites found. Start scanning areas to discover potential locations!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sites.map(site => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" onclick="openSiteModal('${site.id}')">
                    <td class="px-4 py-3">${site.name}</td>
                    <td class="px-4 py-3">${site.type}</td>
                    <td class="px-4 py-3">${site.city}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getProfitabilityColor(site.profitability)}">
                            ${site.profitability}/10
                        </span>
                    </td>
                    <td class="px-4 py-3">${site.traffic.daily.toLocaleString()}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColor(site.status)}">
                            ${site.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="event.stopPropagation(); openSiteModal('${site.id}')" class="text-primary hover:text-opacity-80">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'Potential': 'bg-gray-500 text-white',
                'Contacted': 'bg-blue-500 text-white',
                'Negotiating': 'bg-yellow-500 text-white',
                'Approved': 'bg-green-500 text-white',
                'Rejected': 'bg-red-500 text-white'
            };
            return colors[status] || 'bg-gray-500 text-white';
        }

        // Filter sites
        function filterSites() {
            const search = document.getElementById('sites-search').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;
            const profitFilter = parseInt(document.getElementById('filter-profit').value);

            const filtered = sites.filter(site => {
                const matchSearch = !search ||
                    site.name.toLowerCase().includes(search) ||
                    site.city.toLowerCase().includes(search) ||
                    site.type.toLowerCase().includes(search);
                const matchType = !typeFilter || site.type === typeFilter;
                const matchStatus = !statusFilter || site.status === statusFilter;
                const matchProfit = site.profitability >= profitFilter;

                return matchSearch && matchType && matchStatus && matchProfit;
            });

            displayFilteredSites(filtered);
        }

        // Sort sites
        function sortSites() {
            const sortBy = document.getElementById('sort-by').value;

            sites.sort((a, b) => {
                switch(sortBy) {
                    case 'profitability-desc':
                        return b.profitability - a.profitability;
                    case 'profitability-asc':
                        return a.profitability - b.profitability;
                    case 'revenue-desc':
                        return b.revenue - a.revenue;
                    case 'traffic-desc':
                        return b.traffic.daily - a.traffic.daily;
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    default:
                        return 0;
                }
            });

            filterSites();
        }

        // Display filtered sites
        function displayFilteredSites(filtered) {
            const tbody = document.getElementById('sites-table-body');

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                            No sites match your filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(site => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" onclick="openSiteModal('${site.id}')">
                    <td class="px-4 py-3">${site.name}</td>
                    <td class="px-4 py-3">${site.type}</td>
                    <td class="px-4 py-3">${site.city}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getProfitabilityColor(site.profitability)}">
                            ${site.profitability}/10
                        </span>
                    </td>
                    <td class="px-4 py-3">${site.traffic.daily.toLocaleString()}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColor(site.status)}">
                            ${site.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="event.stopPropagation(); openSiteModal('${site.id}')" class="text-primary hover:text-opacity-80">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            const types = [...new Set(sites.map(s => s.type))].sort();

            const typeSelects = [
                document.getElementById('filter-type'),
                document.getElementById('map-filter-type')
            ];

            typeSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Types</option>' +
                    types.map(type => `<option value="${type}">${type}</option>`).join('');
                select.value = currentValue;
            });
        }

        // Open site modal
        function openSiteModal(siteId) {
            const site = sites.find(s => s.id == siteId);
            if (!site) return;

            currentSiteId = siteId;

            document.getElementById('modal-name').textContent = site.name;
            document.getElementById('modal-type').textContent = site.type;
            document.getElementById('modal-address').textContent = site.address;
            document.getElementById('modal-postcode').textContent = site.postcode;
            document.getElementById('modal-traffic').textContent = site.traffic.daily.toLocaleString() + ' per day';
            document.getElementById('modal-peak').textContent = site.traffic.peak;
            document.getElementById('modal-dwell').textContent = site.traffic.dwellTime;
            document.getElementById('modal-road-traffic').textContent = site.traffic.roadTraffic.toLocaleString() + ' cars/day';
            document.getElementById('modal-major-road').textContent = `${site.traffic.majorRoad} (${site.traffic.roadDistance}km away)`;
            document.getElementById('modal-grid-status').textContent = site.grid.status;
            document.getElementById('modal-grid-capacity').textContent = site.grid.capacity + ' kW';
            document.getElementById('modal-grid-cost').textContent = '£' + site.grid.cost.toLocaleString();
            document.getElementById('modal-grid-utility').textContent = site.grid.utility;
            document.getElementById('modal-competitor').textContent = site.competitors.nearest + ' away';
            document.getElementById('modal-competitors-count').textContent = site.competitors.count;
            document.getElementById('modal-market').textContent = site.competitors.market;
            document.getElementById('modal-revenue').textContent = '£' + site.revenue.toLocaleString();
            document.getElementById('modal-profit').textContent = site.profitability + '/10';
            document.getElementById('modal-parking').textContent = site.parkingSpaces !== null ? site.parkingSpaces : 'N/A';

            const contactDiv = document.getElementById('modal-contact');
            if (site.contact) {
                contactDiv.innerHTML = `
                    <p><span class="font-semibold">Manager:</span> ${site.contact.manager}</p>
                    <p><span class="font-semibold">Phone:</span> ${site.contact.phone}</p>
                    <p><span class="font-semibold">Email:</span> ${site.contact.email}</p>
                `;
            } else {
                contactDiv.innerHTML = `
                    <p><span class="font-semibold">Manager:</span> N/A</p>
                    <p><span class="font-semibold">Phone:</span> N/A</p>
                    <p><span class="font-semibold">Email:</span> N/A</p>
                `;
            }

            document.getElementById('site-modal').classList.remove('hidden');
            document.getElementById('site-modal').classList.add('flex');
        }

        // Close modal
        function closeModal() {
            document.getElementById('site-modal').classList.add('hidden');
            document.getElementById('site-modal').classList.remove('flex');
        }

        // Update site status
        function updateSiteStatus(newStatus) {
            if (!currentSiteId) return;

            const site = sites.find(s => s.id == currentSiteId);
            if (site) {
                site.status = newStatus;
                updateDashboard();
                updateSitesTable();
                closeModal();
            }
        }

        // Show view
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewName + '-view').classList.remove('hidden');

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
            });
            event.target.closest('.nav-btn')?.classList.add('bg-primary', 'text-white');

            // Show/hide the close map button
            const closeMapBtn = document.getElementById('close-map-btn');
            if (viewName === 'map') {
                closeMapBtn.classList.remove('hidden');
                closeMapBtn.classList.add('flex');

                // Small delay to ensure the view is visible before initializing map
                setTimeout(() => {
                    initMap();
                    // Refresh map size after view is shown
                    if (map) {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 200);
                    }
                }, 50);
            } else {
                closeMapBtn.classList.add('hidden');
                closeMapBtn.classList.remove('flex');
            }
        }

        // Initialize map with Leaflet
        function initMap() {
            const mapDiv = document.getElementById('google-map');

            if (sites.length === 0) {
                // Destroy existing map if it exists
                if (map) {
                    map.remove();
                    map = null;
                }

                mapDiv.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-6xl mb-4"></i>
                            <p class="text-xl">No sites to display</p>
                            <p class="text-sm mt-2">Start scanning areas to see sites on the map</p>
                        </div>
                    </div>
                `;
                document.getElementById('scan-map-area-btn').classList.add('hidden');
                document.getElementById('map-legend').classList.add('hidden');
                return;
            }

            // Show scan button and legend
            document.getElementById('scan-map-area-btn').classList.remove('hidden');
            document.getElementById('map-legend').classList.remove('hidden');

            // Calculate center of all sites
            let centerLat = sites.reduce((sum, site) => sum + site.lat, 0) / sites.length;
            let centerLng = sites.reduce((sum, site) => sum + site.lng, 0) / sites.length;

            // If map already exists, just update markers
            if (map) {
                map.setView([centerLat, centerLng], 10);
                createMarkers();
                return;
            }

            // Clear the div and create new map
            mapDiv.innerHTML = '';

            // Create Leaflet map
            map = L.map('google-map').setView([centerLat, centerLng], 10);

            // Add tile layer (OpenStreetMap)
            const isDark = document.documentElement.classList.contains('dark');
            const tileUrl = isDark
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

            L.tileLayer(tileUrl, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Create markers
            createMarkers();

            // Add a small delay to ensure map renders properly
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }

        // Scan map area function
        async function scanMapArea() {
            if (!map) return;

            // Get center of current map view
            const center = map.getCenter();

            // Find nearest city or create custom location
            const customLocation = {
                lat: center.lat,
                lng: center.lng,
                city: 'Map Area',
                input: 'Map Area'
            };

            // Show progress
            showView('scanner');
            document.getElementById('scan-progress').classList.remove('hidden');
            document.getElementById('scan-results').classList.add('hidden');

            const newSites = [];

            // Randomly select 10-15 site types to scan
            const numTypesToScan = Math.floor(Math.random() * 6) + 10;
            const typesToScan = siteTypes.sort(() => 0.5 - Math.random()).slice(0, numTypesToScan);

            // Simulate scanning process
            for (let i = 0; i < typesToScan.length; i++) {
                const type = typesToScan[i];
                const progress = ((i + 1) / typesToScan.length) * 100;
                document.getElementById('scan-progress-bar').style.width = progress + '%';
                document.getElementById('scan-status').textContent = `Scanning for ${type}s...`;

                await new Promise(resolve => setTimeout(resolve, 300));

                // Generate 2-4 sites per type
                const count = Math.floor(Math.random() * 3) + 2;
                for (let j = 0; j < count; j++) {
                    // Use map center with radius
                    const siteLocation = {
                        lat: customLocation.lat + (Math.random() - 0.5) * 0.05,
                        lng: customLocation.lng + (Math.random() - 0.5) * 0.05
                    };
                    const site = generateSite(siteLocation, type, 'Map Area');
                    newSites.push(site);
                    sites.push(site);
                }
            }

            // Show results
            document.getElementById('scan-progress').classList.add('hidden');
            displayScanResults(newSites);
            updateDashboard();
            updateSitesTable();
            populateFilterDropdowns();
        }

        // Get marker color based on profitability
        function getMarkerColor(profitability) {
            if (profitability >= 8) return '#10b981'; // green
            if (profitability >= 6) return '#eab308'; // yellow
            if (profitability >= 4) return '#f97316'; // orange
            return '#ef4444'; // red
        }

        // Create custom marker icon for Leaflet
        function createMarkerIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        // Create markers for all sites
        function createMarkers() {
            if (!map) return;

            // Clear existing markers
            if (markerLayer) {
                map.removeLayer(markerLayer);
            }

            // Create new layer group
            markerLayer = L.layerGroup().addTo(map);

            // Get filter values
            const typeFilter = document.getElementById('map-filter-type').value;
            const profitFilter = parseInt(document.getElementById('map-filter-profit').value);
            const gridFilter = document.getElementById('map-filter-grid').value;
            const statusFilter = document.getElementById('map-filter-status').value;

            // Filter sites
            const filteredSites = sites.filter(site => {
                const matchType = !typeFilter || site.type === typeFilter;
                const matchProfit = site.profitability >= profitFilter;
                const matchGrid = !gridFilter ||
                    (gridFilter === 'available' && site.grid.status === 'Available') ||
                    (gridFilter === 'limited' && site.grid.status === 'Limited');
                const matchStatus = !statusFilter || site.status === statusFilter;
                return matchType && matchProfit && matchGrid && matchStatus;
            });

            if (filteredSites.length === 0) return;

            // Create bounds
            const bounds = L.latLngBounds();

            // Create marker for each filtered site
            filteredSites.forEach(site => {
                const marker = L.marker([site.lat, site.lng], {
                    icon: createMarkerIcon(getMarkerColor(site.profitability)),
                    title: site.name
                });

                // Create popup content
                const parkingText = site.parkingSpaces !== null ? `${site.parkingSpaces} spaces` : 'N/A';
                const popupContent = `
                    <div style="min-width: 250px; font-family: system-ui;">
                        <h3 style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #1f2937;">${site.name}</h3>
                        <p style="color: #6b7280; margin-bottom: 8px; font-size: 14px;">${site.type}</p>
                        <div style="display: grid; gap: 6px; font-size: 13px; color: #374151; margin-bottom: 12px;">
                            <p><strong>Location:</strong> ${site.city}</p>
                            <p><strong>Profitability:</strong> <span style="background: ${getMarkerColor(site.profitability)}; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold;">${site.profitability}/10</span></p>
                            <p><strong>Daily Traffic:</strong> ${site.traffic.daily.toLocaleString()}</p>
                            <p><strong>Revenue:</strong> £${site.revenue.toLocaleString()}/month</p>
                            <p><strong>Grid Status:</strong> ${site.grid.status}</p>
                            <p><strong>Parking:</strong> ${parkingText}</p>
                            <p><strong>Status:</strong> ${site.status}</p>
                        </div>
                        <button onclick="openSiteModal('${site.id}')" style="width: 100%; padding: 8px; background: #5D5CDE; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            View Details
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    closeButton: true,
                    autoClose: true,
                    closeOnClick: true
                });
                marker.addTo(markerLayer);

                // Add to bounds
                bounds.extend([site.lat, site.lng]);
            });

            // Fit map to show all markers
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Filter map markers
        function filterMapMarkers() {
            if (map) {
                createMarkers();
            }
        }

        // Custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 animate-slide-in">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded" onclick="this.closest('.fixed').remove()">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Close map view
        function closeMapView() {
            const closeMapBtn = document.getElementById('close-map-btn');
            closeMapBtn.classList.add('hidden');
            closeMapBtn.classList.remove('flex');
            showView('dashboard');
        }

        // Show auto-update notification
        function showAutoUpdateNotification(message) {
            const banner = document.getElementById('auto-update-banner');
            const text = document.getElementById('auto-update-text');
            text.textContent = message;
            banner.classList.remove('hidden');

            // Hide after 5 seconds
            setTimeout(() => {
                banner.classList.add('hidden');
            }, 5000);
        }

        // Daily auto-update function
        async function dailyAutoUpdate() {
            const today = new Date().toDateString();

            // Check if we need to update (new day)
            if (today !== lastUpdateDate) {
                console.log('Running daily auto-update...');
                lastUpdateDate = today;

                // Get all unique cities from existing sites
                const cities = [...new Set(sites.map(s => s.city))];

                if (cities.length > 0) {
                    // Add new sites to existing scanned cities
                    for (const city of cities) {
                        const location = lookupLocation(city);
                        if (!location) continue;

                        const isLondon = city.toLowerCase().includes('london');
                        const scanRadius = isLondon ? 0.5 : 0.08;

                        // Randomly select 3-5 new site types to add
                        const numNewTypes = Math.floor(Math.random() * 3) + 3;
                        const newTypes = siteTypes.sort(() => 0.5 - Math.random()).slice(0, numNewTypes);

                        for (const type of newTypes) {
                            // Add 1-2 new sites per type
                            const count = Math.floor(Math.random() * 2) + 1;
                            for (let i = 0; i < count; i++) {
                                const siteLocation = {
                                    lat: location.lat + (Math.random() - 0.5) * scanRadius,
                                    lng: location.lng + (Math.random() - 0.5) * scanRadius
                                };
                                const site = generateSite(siteLocation, type, city);
                                sites.push(site);
                            }
                        }
                    }

                    // Update UI
                    updateDashboard();
                    updateSitesTable();
                    populateFilterDropdowns();
                    if (map) {
                        initMap();
                    }

                    console.log(`Auto-update complete: ${sites.length} total sites`);
                    showAutoUpdateNotification(`Daily update complete! ${sites.length} total sites discovered.`);
                }
            }
        }

        // Check for updates every hour
        function startDailyUpdateChecker() {
            // Check immediately
            dailyAutoUpdate();

            // Then check every hour (3600000 ms)
            dailyUpdateInterval = setInterval(dailyAutoUpdate, 3600000);
        }


        // Initialize app
        function initApp() {
            updateDashboard();
            updateSitesTable();
            populateFilterDropdowns();

            // Set first nav button as active
            document.querySelector('.nav-btn').classList.add('bg-primary', 'text-white');

            // Start daily update checker (real production updates)
            startDailyUpdateChecker();
        }

        // Run on load
        initApp();
    </script>
</body>
</html>
